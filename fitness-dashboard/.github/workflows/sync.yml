name: Daily Fitness Data Sync

on:
  # Run daily at 6 AM UTC (7 AM BST / 6 AM GMT)
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Number of days to sync'
        required: false
        default: '7'
      full_sync:
        description: 'Full historical sync'
        type: boolean
        required: false
        default: false

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create config file from secrets
        run: |
          cat > config/config.yaml << EOF
          intervals_icu:
            api_key: "${{ secrets.INTERVALS_API_KEY }}"
            athlete_id: "${{ secrets.INTERVALS_ATHLETE_ID }}"
          
          concept2:
            username: "${{ secrets.CONCEPT2_USERNAME }}"
            password: "${{ secrets.CONCEPT2_PASSWORD }}"
          
          strava:
            client_id: "${{ secrets.STRAVA_CLIENT_ID }}"
            client_secret: "${{ secrets.STRAVA_CLIENT_SECRET }}"
            refresh_token: "${{ secrets.STRAVA_REFRESH_TOKEN }}"
          
          zwift:
            zwift_id: "${{ secrets.ZWIFT_ID }}"
          
          youtube:
            api_key: "${{ secrets.YOUTUBE_API_KEY }}"
            channel_id: "${{ secrets.YOUTUBE_CHANNEL_ID }}"
          
          google_drive:
            credentials_file: "credentials.json"
            folder_id: ""
            raw_folder: "Github/Fitness/Raw"
            processed_folder: "Github/Fitness/Processed"
          
          sync:
            historical_days: 365
            update_frequency: "daily"
            timezone: "Europe/London"
          
          sports:
            cycling:
              - "Ride"
              - "VirtualRide"
              - "EBikeRide"
            running:
              - "Run"
              - "VirtualRun"
            rowing:
              - "Rowing"
            cardio:
              - "Workout"
              - "WeightTraining"
              - "Crossfit"
            other:
              - "Walk"
              - "Swim"
              - "Hike"
          
          processing:
            aggregate_weekly: true
            aggregate_monthly: true
            calculate_trends: true
            power_zones: [0, 144, 189, 234, 279, 324, 369, 999]
            hr_zones: [0, 123, 141, 159, 177, 195, 999]
          EOF
      
      - name: Create Google Drive credentials
        run: |
          echo '${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}' > config/credentials.json
      
      - name: Run sync script
        run: |
          if [ "${{ github.event.inputs.full_sync }}" == "true" ]; then
            python scripts/sync_data.py --config config/config.yaml --full-sync
          else
            DAYS=${{ github.event.inputs.days_back || '7' }}
            python scripts/sync_data.py --config config/config.yaml --days $DAYS
          fi
      
      - name: Upload sync logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs-${{ github.run_id }}
          path: |
            logs/*.log
          retention-days: 30
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Sync failed! Check the logs above."
          # Optional: Add notification to Slack/Discord/Email here
