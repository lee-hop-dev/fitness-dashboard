<!DOCTYPE html>
<!-- v4 fixed -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cycling â€” Training OS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
<div class="app">
  <nav class="sidebar">
    <div class="sidebar-brand">
      <span class="brand-initials">LH</span>
      <span class="brand-text">Training<br>OS</span>
    </div>
    <ul class="nav-links">
      <li class="nav-item"><a href="index.html"><span class="nav-icon">â—ˆ</span><span>Overview</span></a></li>
      <li class="nav-item active"><a href="cycling.html"><span class="nav-icon">ðŸš²</span><span>Cycling</span></a></li>
      <li class="nav-item"><a href="running.html"><span class="nav-icon">â–·</span><span>Running</span></a></li>
      <li class="nav-item"><a href="rowing.html"><span class="nav-icon">âŠ•</span><span>Rowing</span></a></li>
      <li class="nav-item"><a href="cardio.html"><span class="nav-icon">â—Ž</span><span>Cardio</span></a></li>
      <li class="nav-item"><a href="other.html"><span class="nav-icon">â—‹</span><span>Other</span></a></li>
    </ul>
    <div class="sidebar-footer">
      <div class="sync-status"><span class="sync-dot"></span><span class="sync-text" id="last-sync">Loading...</span></div>
    </div>
  </nav>

  <main class="main-content">
    <header class="page-header">
      <div class="header-left">
        <h1 class="page-title">Cycling</h1>
        <span class="page-subtitle">Outdoor Â· Indoor Â· Zwift</span>
      </div>
      <div class="header-right">
        <div class="year-totals">
          <div class="year-stat"><span class="year-stat-value" id="cy-distance">â€”</span><span class="year-stat-label">km YTD</span></div>
          <div class="year-stat"><span class="year-stat-value" id="cy-hours">â€”</span><span class="year-stat-label">hrs YTD</span></div>
          <div class="year-stat"><span class="year-stat-value" id="cy-elevation">â€”</span><span class="year-stat-label">m climb YTD</span></div>
        </div>
      </div>
    </header>

    <div id="loading-state" class="loading-overlay">
      <div class="loading-spinner"></div>
      <span>Loading cycling data...</span>
    </div>

    <div id="page-content" class="hidden">

      <section class="metrics-row" style="grid-template-columns:repeat(4,1fr)">
        <div class="metric-card fitness">
          <div class="metric-label">90d Critical Power</div>
          <div class="metric-value metric-accent" id="cp-value">â€”</div>
          <div class="metric-delta neutral">W Â· 20min best estimate</div>
          <div class="metric-bar"><div class="metric-bar-fill" id="cp-bar" style="width:0%"></div></div>
          <div class="metric-sub">Intervals.icu 90-day CP</div>
        </div>
        <div class="metric-card fatigue">
          <div class="metric-label">W/KG</div>
          <div class="metric-value metric-orange" id="wkg-value">â€”</div>
          <div class="metric-delta neutral" id="wkg-sub">at CP</div>
          <div class="metric-bar"><div class="metric-bar-fill" id="wkg-bar" style="width:0%;background:var(--orange)"></div></div>
          <div class="metric-sub">Based on current weight</div>
        </div>
        <div class="metric-card form">
          <div class="metric-label">Peak Power Â· 90 Days</div>
          <div style="display:flex;flex-direction:column;gap:6px;padding:8px 0">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono)">1 MIN</span>
              <span style="font-size:16px;font-weight:700;color:var(--green)" id="peak-1min">â€”</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono)">5 MIN</span>
              <span style="font-size:16px;font-weight:700;color:var(--accent)" id="peak-5min">â€”</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span style="font-size:10px;color:var(--text-muted);font-family:var(--font-mono)">20 MIN</span>
              <span style="font-size:16px;font-weight:700;color:var(--purple)" id="peak-20min">â€”</span>
            </div>
          </div>
          <div class="metric-sub">W Â· estimated from rides</div>
        </div>
        <div class="metric-card sleep-card">
          <div class="metric-label">This Week</div>
          <div class="metric-value metric-yellow" id="cy-week-count">â€”</div>
          <div class="metric-delta neutral" id="cy-week-meta">rides</div>
          <div class="metric-bar"><div class="metric-bar-fill" id="cy-week-bar" style="width:0%;background:var(--yellow)"></div></div>
          <div class="metric-sub" id="cy-week-sub">Loading...</div>
        </div>
      </section>

      <section class="charts-row two-one">
        <div class="chart-card">
          <div class="chart-header">
            <span class="chart-title">Power Curve Â· 90 Days</span>
            <div class="chart-legend">
              <span class="legend-item ctl">Current</span>
            </div>
          </div>
          <div class="chart-wrap tall"><canvas id="powerCurveChart"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-header"><span class="chart-title">Fitness Â· 42 Days</span></div>
          <div class="chart-wrap tall"><canvas id="cyFitnessChart"></canvas></div>
        </div>
      </section>

      <section class="section">
        <div class="section-header">
          <h2 class="section-title">Last 14 Days</h2>
          <span class="section-meta" id="cy-activities-meta">â€”</span>
        </div>
        <div class="activity-cards" id="cy-activity-cards"></div>
      </section>

      <section class="section">
        <div class="section-header">
          <h2 class="section-title">Strava Segments</h2>
          <span class="section-meta">Coming soon â€” Strava connector in Phase 3</span>
        </div>
        <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:32px;text-align:center;color:var(--text-muted);font-family:var(--font-mono);font-size:12px">
          Strava segment data will appear here once the Strava connector is configured
        </div>
      </section>

    </div>
    <p class="garmin-note">Charts may include data from Garmin devices</p>
  </main>
</div>



<script src="assets/js/charts.js"></script>
<script src="assets/js/data-loader.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const { activities, wellness, meta } = await DATA.loadAll();
    const latest = DATA.latestWellness(wellness);
    const weight = latest?.weight ?? meta?.weight ?? null;

    const today = new Date().toISOString().split('T')[0];
    const cutoff90 = new Date(Date.now() - 90*864e5).toISOString().split('T')[0];
    const cutoff14 = new Date(Date.now() - 14*864e5).toISOString().split('T')[0];
    const weekAgo  = new Date(Date.now() - 7*864e5).toISOString().split('T')[0];

    const allRides = activities.filter(a => a.type === 'Ride' || a.type === 'VirtualRide');
    const rides90  = allRides.filter(a => a.date >= cutoff90);
    const rides14  = allRides.filter(a => a.date >= cutoff14);
    const ridesWk  = allRides.filter(a => a.date >= weekAgo);
    const withPower = rides90.filter(a => a.avg_power != null);

    // YTD
    const year = new Date().getFullYear();
    const ytdRides = allRides.filter(a => a.date?.startsWith(String(year)));
    document.getElementById('cy-distance').textContent  = Math.round(ytdRides.reduce((s,a)=>s+(a.distance||0),0)/1000).toLocaleString();
    document.getElementById('cy-hours').textContent     = (ytdRides.reduce((s,a)=>s+(a.duration||0),0)/3600).toFixed(1);
    document.getElementById('cy-elevation').textContent = Math.round(ytdRides.reduce((s,a)=>s+(a.elevation||0),0)).toLocaleString();

    // TRUE Intervals CP
const cp = Number(latest?.cp ?? meta?.cp ?? null);

document.getElementById('cp-value').textContent = cp ? cp + 'W' : 'â€”';

if (cp) {
  const pct = Math.min(100, (cp / 400) * 100);
  document.getElementById('cp-bar').style.width = pct + '%';

  if (weight) {
    const wkg = (cp / weight).toFixed(2);
    document.getElementById('wkg-value').textContent = wkg;
    document.getElementById('wkg-sub').textContent = `at CP Â· ${weight}kg`;
    document.getElementById('wkg-bar').style.width =
      Math.min(100, (parseFloat(wkg) / 6) * 100) + '%';
  }
}

        // Peak power from Intervals.icu (defensive-safe)
        const peak1min  = Number(latest?.p1  ?? meta?.p1  ?? null);
        const peak5min  = Number(latest?.p5  ?? meta?.p5  ?? null);
        const peak20min = Number(latest?.p20 ?? meta?.p20 ?? cp ?? null);

        if (peak1min > 0) {
            document.getElementById('peak-1min').textContent = peak1min + 'W';
        }

        if (peak5min > 0) {
            document.getElementById('peak-5min').textContent = peak5min + 'W';
        }

        if (peak20min > 0) {
            document.getElementById('peak-20min').textContent = peak20min + 'W';
        }




    // This week
    const wkDist = ridesWk.reduce((s,a)=>s+(a.distance||0),0)/1000;
    const wkHrs  = ridesWk.reduce((s,a)=>s+(a.duration||0),0)/3600;
    document.getElementById('cy-week-count').textContent = ridesWk.length;
    document.getElementById('cy-week-meta').textContent  = `rides Â· ${wkDist.toFixed(0)} km`;
    document.getElementById('cy-week-sub').textContent   = `${wkHrs.toFixed(1)} hrs Â· TSS ${ridesWk.reduce((s,a)=>s+(a.tss||0),0)}`;
    document.getElementById('cy-week-bar').style.width   = Math.min(100, ridesWk.length * 25) + '%';

            // Power curve chart â€” use true Intervals.icu data if available
    if (meta?.power_curve && Array.isArray(meta.power_curve) && meta.power_curve.length > 0) {

        const powerBests = meta.power_curve
            .sort((a, b) => a.duration - b.duration)
            .map(p => ({
                label: formatDurationLabel(p.duration),
                value: Number(p.power),
                hr: null
            }));

        buildPowerCurveChart(
            'powerCurveChart',
            powerBests,
            null,
            cp,
            peak5min,
            peak20min
        );

    } else if (withPower.length > 0) {

        // Safe fallback if Intervals curve not present
        const powerBests = buildPowerBestsFromRides(withPower, cp);

        buildPowerCurveChart(
            'powerCurveChart',
            powerBests,
            null,
            cp,
            peak5min,
            peak20min
        );
    }



    // Fitness chart
    const fitnessTrend = wellness.filter(w => w.ctl != null).slice(-42);
    if (fitnessTrend.length) buildFitnessChart('cyFitnessChart', fitnessTrend);

    // Last 14 days cards
    const totalDist14 = rides14.reduce((s,a)=>s+(a.distance||0),0)/1000;
    const totalHrs14  = rides14.reduce((s,a)=>s+(a.duration||0),0)/3600;
    document.getElementById('cy-activities-meta').textContent =
      `${rides14.length} rides Â· ${totalDist14.toFixed(0)} km Â· ${totalHrs14.toFixed(1)} hrs`;

    document.getElementById('cy-activity-cards').innerHTML = rides14.map(a => `
      <div class="activity-card">
        <div class="activity-card-type type-ride">
          <span class="type-dot dot-ride"></span>
          ${a.type === 'VirtualRide' ? 'Zwift' : 'Outdoor'}
        </div>
        <div class="activity-card-name">${a.name}</div>
        <div class="activity-card-stats">
          <div class="activity-stat"><span class="activity-stat-value">${formatDuration(a.duration)}</span><span class="activity-stat-label">Duration</span></div>
          <div class="activity-stat"><span class="activity-stat-value">${a.distance?(a.distance/1000).toFixed(1):'â€”'}</span><span class="activity-stat-label">km</span></div>
          <div class="activity-stat"><span class="activity-stat-value">${a.avg_power?a.avg_power+'W':'â€”'}</span><span class="activity-stat-label">Avg Power</span></div>
          <div class="activity-stat"><span class="activity-stat-value">${a.avg_hr||'â€”'}</span><span class="activity-stat-label">Avg HR</span></div>
        </div>
        <div class="activity-card-footer">
          <span>${a.date}</span>
          <span class="tss-val">TSS ${a.tss}${a.if_val?' Â· IF '+a.if_val.toFixed(2):''}</span>
        </div>
      </div>`).join('') || '<div style="color:var(--text-muted);font-size:12px;padding:20px;font-family:var(--font-mono)">No cycling activities in last 14 days</div>';

    document.getElementById('last-sync').textContent = 'Synced ' + new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('page-content').classList.remove('hidden');

  } catch(err) {
    document.getElementById('loading-state').innerHTML = `<div class="error-state">${err.message}</div>`;
    console.error(err);
  }
});

function buildPowerBestsFromRides(rides, cp) {
  const labels   = ['5s','10s','15s','30s','1min','2min','3min','5min','6min','8min','10min','12min','15min','20min','30min','40min','60min','90min'];
  const factors  = [3.6, 3.3, 3.1, 2.8, 2.3, 1.85, 1.65, 1.45, 1.38, 1.28, 1.18, 1.12, 1.07, 1.02, 0.96, 0.92, 0.87, 0.80];
  const hrBases  = [158, 160, 162, 165, 172, 178, 180, 182, 181, 180, 178, 177, 175, 173, 170, 168, 165, 161];
  const base = cp || Math.max(...rides.map(r => r.avg_power));

  return labels.map((label, i) => ({
    label,
    value: Math.round(base * factors[i]),
    hr: hrBases[i]
  }));
}

function formatDuration(seconds) {
  if (!seconds) return 'â€”';

  if (seconds >= 3600)
    return `${Math.floor(seconds/3600)}h ${Math.floor((seconds%3600)/60)}m`;

  return `${Math.floor(seconds/60)}:${String(seconds%60).padStart(2,'0')}`;
}

function formatDurationLabel(seconds) {
  if (seconds < 60) return seconds + 's';
  if (seconds < 3600) return Math.round(seconds / 60) + 'min';
  return Math.round(seconds / 3600) + 'h';
}
</script>
</body>
</html>
