<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rowing â€” Fitness Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
<div class="app">
  <nav class="sidebar">
    <div class="sidebar-brand">
      <span class="brand-initials">LH</span>
      <span class="brand-text">Training<br>OS</span>
    </div>
    <ul class="nav-links">
      <li class="nav-item"><a href="index.html"><span class="nav-icon">â—ˆ</span><span>Overview</span></a></li>
      <li class="nav-item"><a href="cycling.html"><span class="nav-icon">â¬¡</span><span>Cycling</span></a></li>
      <li class="nav-item"><a href="running.html"><span class="nav-icon">â–·</span><span>Running</span></a></li>
      <li class="nav-item active"><a href="rowing.html"><span class="nav-icon">âŠ•</span><span>Rowing</span></a></li>
      <li class="nav-item"><a href="cardio.html"><span class="nav-icon">â—</span><span>Cardio</span></a></li>
      <li class="nav-item"><a href="other.html"><span class="nav-icon">â—‹</span><span>Other</span></a></li>
    </ul>
    <div class="sidebar-footer">
      <div class="sync-status"><span class="sync-dot"></span><span class="sync-text">Synced 6:00 AM</span></div>
    </div>
  </nav>
  <main class="main-content">
    <header class="page-header">
      <div class="header-left">
        <h1 class="page-title">Rowing</h1>
        <span class="page-subtitle">Concept2 Â· Erg Data</span>
      </div>
    </header>
    <section class="metrics-row" style="grid-template-columns:repeat(4,1fr)">
      <div class="metric-card fitness">
        <div class="metric-label">2K BEST</div>
        <div class="metric-value" style="color:var(--accent)" id="best-2k">â€”</div>
        <div class="metric-delta neutral" id="best-2k-pace">â€”</div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:78%"></div></div>
        <div class="metric-sub">All-time best</div>
      </div>
      <div class="metric-card hrv">
        <div class="metric-label">5K BEST</div>
        <div class="metric-value" style="color:var(--purple)" id="best-5k">â€”</div>
        <div class="metric-delta neutral" id="best-5k-pace">â€”</div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:65%;background:var(--purple)"></div></div>
        <div class="metric-sub">All-time best</div>
      </div>
      <div class="metric-card form">
        <div class="metric-label">60 MIN BEST</div>
        <div class="metric-value" style="color:var(--green)" id="best-60min">â€”</div>
        <div class="metric-delta neutral" id="best-60min-pace">â€”</div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:55%;background:var(--green)"></div></div>
        <div class="metric-sub">All-time best</div>
      </div>
      <div class="metric-card sleep">
        <div class="metric-label">THIS WEEK</div>
        <div class="metric-value" style="color:var(--yellow)" id="week-count">â€”</div>
        <div class="metric-delta neutral" id="week-summary">â€”</div>
        <div class="metric-bar"><div class="metric-bar-fill" style="width:28%;background:var(--yellow)"></div></div>
        <div class="metric-sub" id="week-details">â€”</div>
      </div>
    </section>

    <section class="section">
      <div class="section-header">
        <h2>Recent Rowing Sessions</h2>
        <span class="section-meta">Last 30 days Â· All sources</span>
      </div>
      <div class="activity-cards" id="row-cards">
        <div style="color:var(--text-muted);font-family:var(--font-mono);font-size:12px;padding:20px">Loading rowing activities...</div>
      </div>
    </section>
    <section class="charts-row" style="grid-template-columns:1fr 1fr">
      <div class="chart-card">
        <div class="chart-header"><h3>Pace Trend Â· 30 Days</h3></div>
        <div class="chart-wrap"><canvas id="rowPaceChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-header"><h3>Volume Â· Weekly</h3></div>
        <div class="chart-wrap"><canvas id="rowVolumeChart"></canvas></div>
      </div>
    </section>
  </main>
</div>

<script src="assets/js/charts.js"></script>
<script src="assets/js/data-loader.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  console.log('ğŸš€ Rowing page starting...');
  
  try {
    const { activities, weeklyTSS } = await DATA.loadAll();
    console.log('ğŸ“Š Total activities loaded:', activities.length);

    // ULTRA-COMPREHENSIVE ROWING FILTERING - catch everything possible
    const rows = activities.filter(a => {
      const type = (a.type || '').toLowerCase();
      const name = (a.name || '').toLowerCase();
      const description = (a.description || '').toLowerCase();
      const source = (a.source || '').toLowerCase();
      const sport = (a.sport || '').toLowerCase();
      
      // All possible rowing/erg terms
      const rowingTerms = [
        'row', 'rowing', 'erg', 'ergo', 'concept', 'c2', 'concept2', 
        'indoor row', 'indoor rowing', 'ergometer', 'rower', 'sculling',
        'sweep', 'oar', 'paddle', 'kayak', 'canoe', 'dragon boat'
      ];
      
      const allText = `${type} ${name} ${description} ${source} ${sport}`.toLowerCase();
      
      // Check if any rowing term appears anywhere in the activity data
      const hasRowingTerm = rowingTerms.some(term => allText.includes(term));
      
      // Also check exact type matches (case sensitive)
      const exactTypeMatch = [
        'Rowing', 'Row', 'Erg', 'Indoor Rowing', 'Concept2', 
        'Ergometer', 'Kayaking', 'Canoeing', 'Canoe', 'Kayak'
      ].includes(a.type);
      
      return hasRowingTerm || exactTypeMatch;
    });
    
    console.log('ğŸš£ Filtered rowing activities:', rows.length);
    
    // Detailed breakdown by source
    const sourceBreakdown = {};
    rows.forEach(a => {
      const source = a.source || 'Unknown';
      sourceBreakdown[source] = (sourceBreakdown[source] || 0) + 1;
    });
    console.log('ğŸ“Š Rowing activities by source:', sourceBreakdown);
    
    // Check specifically for different erg data sources
    const ergDataActivities = activities.filter(a => 
      (a.source || '').toLowerCase().includes('ergdata') ||
      (a.source || '').toLowerCase().includes('concept2') ||
      (a.name || '').toLowerCase().includes('ergdata') ||
      (a.description || '').toLowerCase().includes('concept2')
    );
    
    const stravaRowingActivities = activities.filter(a => 
      (a.source || '').toLowerCase().includes('strava') && 
      ((a.type || '').toLowerCase().includes('row') || 
       (a.name || '').toLowerCase().includes('row') ||
       (a.sport || '').toLowerCase().includes('row'))
    );
    
    console.log('ğŸ“± ErgData activities:', ergDataActivities.length);
    console.log('ğŸƒ Strava rowing activities:', stravaRowingActivities.length);
    
    // Show detailed info about found activities
    if (rows.length > 0) {
      console.log('ğŸ“‹ All rowing activities found:');
      rows.forEach((a, i) => {
        console.log(`${i+1}. "${a.name}" | Type: ${a.type} | Source: ${a.source} | Date: ${a.date}`);
        if (a.distance) console.log(`   Distance: ${(a.distance/1000).toFixed(1)}km | Duration: ${Math.floor((a.duration||0)/60)}min`);
      });
    }
    
    // Sync status display removed - debug section deleted from HTML

    const weekCutoff = new Date(Date.now() - 7*864e5).toISOString().split('T')[0];
    const weekRows = rows.filter(a => a.date >= weekCutoff);
    const recent30 = rows.filter(a => {
      const cutoff = new Date(Date.now() - 30*864e5).toISOString().split('T')[0];
      return a.date >= cutoff;
    });
    
    console.log('ğŸ“… This week activities:', weekRows.length);
    console.log('ğŸ“… Last 30 days activities:', recent30.length);

    // Calculate personal bests from actual data
    const calculatePBs = () => {
      // 2K best (distance around 2000m, allow 10% tolerance)
      const twoKs = rows.filter(a => a.distance && Math.abs(a.distance - 2000) < 200);
      const best2K = twoKs.length > 0 ? Math.min(...twoKs.map(a => a.duration)) : null;
      
      // 5K best (distance around 5000m, allow 5% tolerance)
      const fiveKs = rows.filter(a => a.distance && Math.abs(a.distance - 5000) < 250);
      const best5K = fiveKs.length > 0 ? Math.min(...fiveKs.map(a => a.duration)) : null;
      
      // 60min best (duration around 3600 seconds, allow 10 min tolerance)
      const sixtyMins = rows.filter(a => a.duration && Math.abs(a.duration - 3600) < 600);
      const best60Min = sixtyMins.length > 0 ? Math.max(...sixtyMins.map(a => a.distance)) : null;
      
      console.log('ğŸ† Personal bests search:', {
        '2K candidates': twoKs.length,
        '5K candidates': fiveKs.length,
        '60min candidates': sixtyMins.length,
        best2K, best5K, best60Min
      });
      
      return { best2K, best5K, best60Min };
    };

    const { best2K, best5K, best60Min } = calculatePBs();
    
    // Update PB displays
    if (best2K) {
      const minutes = Math.floor(best2K / 60);
      const seconds = best2K % 60;
      const pace500 = Math.round(best2K / 4);
      const paceMin = Math.floor(pace500 / 60);
      const paceSec = pace500 % 60;
      document.getElementById('best-2k').textContent = `${minutes}:${seconds.toString().padStart(2,'0')}`;
      document.getElementById('best-2k-pace').textContent = `${paceMin}:${paceSec.toString().padStart(2,'0')}/500m`;
    }
    
    if (best5K) {
      const minutes = Math.floor(best5K / 60);
      const seconds = best5K % 60;
      const pace500 = Math.round(best5K / 10);
      const paceMin = Math.floor(pace500 / 60);
      const paceSec = pace500 % 60;
      document.getElementById('best-5k').textContent = `${minutes}:${seconds.toString().padStart(2,'0')}`;
      document.getElementById('best-5k-pace').textContent = `${paceMin}:${paceSec.toString().padStart(2,'0')}/500m`;
    }
    
    if (best60Min) {
      const distanceKm = (best60Min / 1000).toFixed(1);
      const pace500 = Math.round(3600 / (best60Min / 500));
      const paceMin = Math.floor(pace500 / 60);
      const paceSec = pace500 % 60;
      document.getElementById('best-60min').textContent = distanceKm;
      document.getElementById('best-60min-pace').textContent = `km Â· ${paceMin}:${paceSec.toString().padStart(2,'0')}/500m`;
    }

    // Update this week summary
    const weekDist = weekRows.reduce((s,a) => s+(a.distance||0),0)/1000;
    const weekHrs = weekRows.reduce((s,a) => s+(a.duration||0),0)/3600;
    const weekTSS = weekRows.reduce((s,a) => s+(a.tss||0),0);
    
    document.getElementById('week-count').textContent = weekRows.length;
    document.getElementById('week-summary').textContent = `session${weekRows.length!==1?'s':''} Â· ${weekDist.toFixed(0)} km`;
    document.getElementById('week-details').textContent = `${Math.round(weekHrs * 60)} min Â· TSS ${weekTSS}`;

    // Activity cards - FORCE DISPLAY ALL ROWING ACTIVITIES
    const container = document.getElementById('row-cards');
    if (container) {
      console.log('ğŸ“¦ Updating activity cards with', recent30.length, 'recent activities...');
      
      if (recent30.length === 0) {
        // Show helpful message with total count
        container.innerHTML = `
          <div style="color:var(--text-muted);font-family:var(--font-mono);font-size:12px;padding:20px;">
            <div>No rowing sessions in last 30 days</div>
            <div style="margin-top:10px;">
              ğŸ“Š Found ${rows.length} total rowing activities<br>
              ğŸ“Š Sources: ${Object.keys(sourceBreakdown).join(', ')}<br>
              ğŸ’¡ Activities older than 30 days aren't shown here
            </div>
          </div>
        `;
      } else {
        const formatDuration = (seconds) => {
          if (!seconds) return 'â€”';
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins}:${secs.toString().padStart(2,'0')}`;
        };
        
        container.innerHTML = recent30.map(a => {
          // Convert avg_speed (m/s) to 500m split pace
          let splitStr = 'â€”';
          if (a.avg_speed && a.avg_speed > 0) {
            const split500 = Math.round(500 / a.avg_speed);
            splitStr = Math.floor(split500/60) + ':' + String(split500%60).padStart(2,'0');
          } else if (a.distance && a.duration && a.distance > 0) {
            const split500 = Math.round((a.duration / a.distance) * 500);
            splitStr = Math.floor(split500/60) + ':' + String(split500%60).padStart(2,'0');
          }
          
          // Get source icon
          const sourceIcon = a.source === 'STRAVA' ? 'ğŸƒ' : 
                           a.source === 'ERGDATA' ? 'ğŸ“±' : 
                           a.source === 'ZWIFT' ? 'ğŸš´' : 'ğŸ“Š';
          
          return `<div class="activity-card">
            <div class="activity-card-type type-row"><span class="type-dot dot-row"></span>${a.type || 'Rowing'}</div>
            <div class="activity-card-name">${a.name || 'Rowing Session'}</div>
            <div class="activity-card-stats">
              <div class="activity-stat"><span class="activity-stat-value">${formatDuration(a.duration)}</span><span class="activity-stat-label">Duration</span></div>
              <div class="activity-stat"><span class="activity-stat-value">${a.distance ? (a.distance/1000).toFixed(1) : 'â€”'}</span><span class="activity-stat-label">km</span></div>
              <div class="activity-stat"><span class="activity-stat-value">${splitStr}</span><span class="activity-stat-label">/500m</span></div>
              <div class="activity-stat"><span class="activity-stat-value">${a.avg_hr || 'â€”'}</span><span class="activity-stat-label">Avg HR</span></div>
            </div>
            <div class="activity-card-footer"><span>${a.date} ${sourceIcon} ${a.source || 'Unknown'}</span><span class="tss-val">TSS ${a.tss || 0}</span></div>
          </div>`;
        }).join('');
      }
      
      console.log('âœ… Activity cards updated successfully');
    }

    // Build charts if we have data
    const trendRows = rows.slice(0,20).reverse();
    if (trendRows.length >= 2) {
      const dates = trendRows.map(a => a.date);
      const splits = trendRows.map(a => {
        if (a.avg_speed && a.avg_speed > 0) {
          return Math.round(500 / a.avg_speed);
        } else if (a.distance && a.duration && a.distance > 0) {
          return Math.round((a.duration / a.distance) * 500);
        }
        return null;
      });
      try {
        buildPaceTrendChart('rowPaceChart', dates, splits);
        console.log('ğŸ“ˆ Pace trend chart built');
      } catch(e) {
        console.log('ğŸ“ˆ Chart error:', e.message);
      }
    } else {
      console.log('ğŸ“ˆ Not enough data for pace trend chart');
    }

    const rowWeekly = weeklyTSS.slice(-12).map(w => ({
      week: w.week,
      year: w.year,
      ride: 0, run: 0, row: w.row || 0, other: 0
    }));
    if (rowWeekly.some(w => w.row > 0)) {
      try {
        buildTSSChart('rowVolumeChart', rowWeekly);
        console.log('ğŸ“Š Volume chart built');
      } catch(e) {
        console.log('ğŸ“Š Chart error:', e.message);
      }
    } else {
      console.log('ğŸ“Š No weekly rowing data for volume chart');
    }

    console.log('ğŸ Rowing page loaded successfully');

  } catch(err) {
    console.error('ğŸ’¥ Rowing page error:', err);
    const container = document.getElementById('row-cards');
    if (container) {
      container.innerHTML = `<div style="color:var(--red);font-family:var(--font-mono);font-size:12px;padding:20px;">
        âŒ Error loading data: ${err.message}<br>
        <details style="margin-top:10px;">
          <summary>Debug Info</summary>
          <pre style="font-size:10px;">${err.stack}</pre>
        </details>
      </div>`;
    }
  }
});
</script>
</body>
</html>
