<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rowing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="assets/css/main.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="container">

  <h1>ðŸš£ Rowing</h1>
  <p class="subtitle">Concept2 Â· Erg Data</p>

  <!-- Personal Bests -->
  <div class="grid-3">
    <div class="card">
      <h3>2K Best</h3>
      <div id="best-2k">â€”</div>
    </div>

    <div class="card">
      <h3>5K Best</h3>
      <div id="best-5k">â€”</div>
    </div>

    <div class="card">
      <h3>60 Min Best</h3>
      <div id="best-60m">â€”</div>
    </div>
  </div>

  <!-- This Week -->
  <div class="card">
    <h2>This Week</h2>
    <div id="week-summary">Loading...</div>
  </div>

  <!-- Recent Sessions -->
  <div class="card">
    <h2>Recent Rowing Sessions</h2>
    <div id="recent-rows">Loading...</div>
  </div>

  <!-- Charts -->
  <div class="card">
    <h2>Pace Trend Â· 30 Days</h2>
    <canvas id="paceChart"></canvas>
  </div>

  <div class="card">
    <h2>Volume Â· Weekly</h2>
    <canvas id="volumeChart"></canvas>
  </div>

</div>

<script src="assets/js/data-loader.js"></script>
<script src="assets/js/charts.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const activities = await loadActivities();

  const rows = activities.filter(a =>
    (a.type || '').toLowerCase().includes('row')
  );

  // ---------- Personal Bests ----------
  const formatTime = s => {
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return `${m}:${sec.toString().padStart(2,'0')}`;
  };

  const best2k = rows
    .filter(a => a.distance >= 1900 && a.distance <= 2100)
    .sort((a,b) => a.duration - b.duration)[0];

  if (best2k) {
    document.getElementById("best-2k").innerHTML =
      `${formatTime(best2k.duration)}<br>${best2k.date}`;
  }

  const best5k = rows
    .filter(a => a.distance >= 4900 && a.distance <= 5100)
    .sort((a,b) => a.duration - b.duration)[0];

  if (best5k) {
    document.getElementById("best-5k").innerHTML =
      `${formatTime(best5k.duration)}<br>${best5k.date}`;
  }

  const best60 = rows
    .filter(a => a.duration >= 3500 && a.duration <= 3900)
    .sort((a,b) => b.distance - a.distance)[0];

  if (best60) {
    document.getElementById("best-60m").innerHTML =
      `${(best60.distance/1000).toFixed(1)} km<br>${best60.date}`;
  }

  // ---------- This Week ----------
  const weekCutoff = new Date(Date.now() - 7*864e5)
    .toISOString().split('T')[0];

  const weekRows = rows.filter(a => a.date >= weekCutoff);

  const totalKm = weekRows.reduce((sum,a)=>sum+(a.distance||0),0)/1000;
  const totalMin = weekRows.reduce((sum,a)=>sum+(a.duration||0),0)/60;

  document.getElementById("week-summary").innerHTML =
    `${weekRows.length} session(s) Â· ${totalKm.toFixed(1)} km Â· ${Math.round(totalMin)} min`;

  // ---------- Recent Sessions ----------
  const recent = rows
    .sort((a,b)=>b.date.localeCompare(a.date))
    .slice(0,10);

  const recentHtml = recent.map(a => `
    <div class="session">
      <strong>${a.name || 'Rowing'}</strong><br>
      ${formatTime(a.duration)} Â· ${(a.distance/1000).toFixed(1)} km<br>
      ${a.date}
    </div>
  `).join('');

  document.getElementById("recent-rows").innerHTML = recentHtml;

  // ---------- Charts ----------
  renderPaceChart(rows);
  renderVolumeChart(rows);

});
</script>

</body>
</html>
