<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Training OS</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
<div class="app">

<nav class="sidebar">
  <div class="sidebar-brand">
    <span class="brand-initials">LH</span>
    <span class="brand-text">Training<br>OS</span>
  </div>

  <ul class="nav-links">
    <li class="nav-item active"><a href="index.html"><span class="nav-icon">◈</span><span>Overview</span></a></li>
    <li class="nav-item"><a href="cycling.html"><span class="nav-icon">⬡</span><span>Cycling</span></a></li>
    <li class="nav-item"><a href="running.html"><span class="nav-icon">▷</span><span>Running</span></a></li>
    <li class="nav-item"><a href="rowing.html"><span class="nav-icon">⊕</span><span>Rowing</span></a></li>
    <li class="nav-item"><a href="cardio.html"><span class="nav-icon">◎</span><span>Cardio</span></a></li>
    <li class="nav-item"><a href="other.html"><span class="nav-icon">○</span><span>Other</span></a></li>
  </ul>

  <div class="sidebar-footer">
    <div class="sync-status">
      <span class="sync-dot"></span>
      <span class="sync-text" id="last-sync">Loading...</span>
    </div>
  </div>
</nav>

<main class="main-content">

<header class="page-header">
  <div class="header-left">
    <h1 class="page-title">Overview</h1>
    <span class="page-subtitle" id="page-subtitle">—</span>
  </div>
</header>

<div id="loading-state" class="loading-overlay">
  <div class="loading-spinner"></div>
  <span id="loading-msg">Loading dashboard data...</span>
</div>

<div id="error-state" class="error-state hidden">
  <strong>No data found.</strong> <span id="error-msg"></span>
</div>

<div id="dashboard-content" class="hidden">

<section class="metrics-row" role="region" aria-label="Training metrics">

  <!-- metric cards unchanged structurally -->

</section>

<section class="charts-row two-one">
  <div class="chart-card">
    <div class="chart-wrap tall">
      <canvas id="fitnessChart" role="img" aria-label="Fitness trend chart"></canvas>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-wrap tall">
      <canvas id="tssChart" role="img" aria-label="Weekly training stress chart"></canvas>
    </div>
  </div>
</section>

<section class="section">
  <div class="section-header">
    <h2 class="section-title">Last 7 Days</h2>
    <span class="section-meta" id="week-summary">—</span>
  </div>
  <div class="activity-cards" id="activity-cards"></div>
</section>

<section class="charts-row full">
  <div class="chart-card">
    <div class="chart-wrap">
      <canvas id="hrvSleepChart" role="img" aria-label="HRV and sleep chart"></canvas>
    </div>
  </div>
</section>

<section class="section">
  <div class="section-header">
    <h2 class="section-title">Calendar</h2>
    <span class="section-meta">Last 4 weeks · by date</span>
  </div>
  <div class="calendar-wrap" id="calendar-wrap"></div>
</section>

<section class="section">
  <div class="section-header">
    <h2 class="section-title">Activity Heatmap</h2>
  </div>
  <div class="heatmap-wrap" id="heatmap-wrap">
    <div id="heatmap-inner"></div>
  </div>
</section>

</div>
</main>
</div>

<script src="assets/js/charts.js"></script>
<script src="assets/js/data-loader.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  try {

    const { activities, wellness, weeklyTSS, ytd, heatmap1y, athlete, meta } = await DATA.loadAll();

    /* ---------- SYNC TIME ---------- */
    const updated = new Date(meta.last_updated);
    const diffHrs = Math.round((Date.now() - updated) / 3600000);
    document.getElementById('last-sync').textContent =
      diffHrs < 1 ? 'Updated just now'
      : diffHrs < 24 ? `Updated ${diffHrs}h ago`
      : `Updated ${Math.floor(diffHrs/24)}d ago`;

    /* ---------- SUBTITLE ---------- */
    const weekNum = getISOWeekNum(new Date());
    const weekTSS = weeklyTSS.at(-1)?.total || 0;
    document.getElementById('page-subtitle').textContent =
      `${new Date().getFullYear()} · Week ${weekNum} · ${weekTSS} TSS`;

    /* ---------- HRV WEEKLY DELTA ---------- */
    const lw = DATA.latestWellness(wellness);
    if (lw.hrv && wellness.length > 7) {
      const prev = wellness[wellness.length - 7]?.hrv;
      if (prev) {
        const diff = lw.hrv - prev;
        const hrvDeltaEl = document.querySelector('.hrv-card .metric-delta');
        if (hrvDeltaEl) {
          hrvDeltaEl.textContent =
            `${diff > 0 ? '+' : ''}${diff} vs last week`;
          hrvDeltaEl.className =
            `metric-delta ${diff >= 0 ? 'positive' : 'negative'}`;
        }
      }
    }

    /* ---------- DYNAMIC TITLE ---------- */
    document.title =
      `Training OS · CTL ${lw.ctl?.toFixed(0) || '—'} · TSB ${lw.tsb?.toFixed(0) || '—'}`;

    /* ---------- ACTIVITY CARDS ---------- */
    renderActivityCards(DATA.recentActivities(activities, 7));

    /* ---------- CALENDAR ---------- */
    renderCalendar(activities);

    /* ---------- HEATMAP ---------- */
    renderHeatmap(heatmap1y);

    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('dashboard-content').classList.remove('hidden');

  } catch(err) {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('error-state').classList.remove('hidden');
    document.getElementById('error-msg').textContent = err.message;
  }
});

/* ---------- SMART EMPTY STATE ---------- */
function renderActivityCards(activities) {
  const container = document.getElementById('activity-cards');

  if (!activities.length) {
    container.innerHTML =
      `<div style="color:var(--text-muted);font-family:var(--font-mono);font-size:12px;padding:20px">
        No training this week.<br>
        Stay consistent — next session builds momentum.
      </div>`;
    return;
  }
}

/* ---------- TIMEZONE-SAFE CALENDAR ---------- */
function formatDateLocal(dateObj) {
  return dateObj.getFullYear() + '-' +
         String(dateObj.getMonth()+1).padStart(2,'0') + '-' +
         String(dateObj.getDate()).padStart(2,'0');
}

</script>
</body>
</html>
