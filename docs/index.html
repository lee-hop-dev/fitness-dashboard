<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lee Hopkins — Training OS</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>

<div class="app">

<nav class="sidebar">
<div class="sidebar-brand">
<span class="brand-initials">LH</span>
<span class="brand-text">Training<br>OS</span>
</div>

<ul class="nav-links">
<li class="nav-item active"><a href="index.html">Overview</a></li>
<li class="nav-item"><a href="cycling.html">Cycling</a></li>
<li class="nav-item"><a href="running.html">Running</a></li>
<li class="nav-item"><a href="rowing.html">Rowing</a></li>
<li class="nav-item"><a href="cardio.html">Cardio</a></li>
<li class="nav-item"><a href="other.html">Other</a></li>
</ul>

<div class="sidebar-footer">
<div class="sync-status">
<span class="sync-dot"></span>
<span id="last-sync">Loading...</span>
</div>
</div>
</nav>


<main class="main-content">

<header class="page-header">
<div>
<h1 class="page-title">Overview</h1>
<div id="page-subtitle">—</div>
</div>
</header>


<div id="loading-state">Loading dashboard data...</div>

<div id="error-state" class="hidden">
No data found. <span id="error-msg"></span>
</div>

<div id="dashboard-content" class="hidden">

<section class="section">
<h2 class="section-title">Calendar</h2>
<div class="calendar-wrap" id="calendar-wrap"></div>
</section>

</div>
</main>
</div>



<script src="assets/js/data-loader.js"></script>
<script src="assets/js/charts.js"></script>



<script>

//
// ===============================
// SAFE HELPERS
// ===============================
//

// ISO week number fallback
function getISOWeekNum(date)
{
if(!date) return '';

const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
const dayNum = d.getUTCDay() || 7;
d.setUTCDate(d.getUTCDate() + 4 - dayNum);
const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}


// duration formatter fallback
function safeFormatDuration(sec)
{
if(typeof formatDuration === 'function')
return formatDuration(sec);

if(!sec) return '';

const h = Math.floor(sec/3600);
const m = Math.floor((sec%3600)/60);

if(h > 0) return `${h}h ${m}m`;
return `${m}m`;
}



//
// ===============================
// FORM HELPERS
// ===============================
//

function getFormClass(tsb)
{
if(tsb == null) return '';
return tsb >= 0 ? 'fresh' : 'tired';
}


function predictNextCTLATL(ctl, atl, tss)
{
return {
ctl: ctl + (tss - ctl) / 42,
atl: atl + (tss - atl) / 7
};
}



//
// ===============================
// LOAD DATA
// ===============================
//

document.addEventListener('DOMContentLoaded', async () =>
{

try
{

const { activities, wellness, meta } = await DATA.loadAll();


// sync time

if(meta?.last_updated)
{
const updated = new Date(meta.last_updated);

document.getElementById('last-sync').textContent =
'Updated ' + updated.toLocaleDateString('en-GB',
{ day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' });
}


// subtitle

const weekNum = getISOWeekNum(new Date());

document.getElementById('page-subtitle').textContent =
`${new Date().getFullYear()} · Week ${weekNum}`;



//
// CALENDAR
//

renderCalendar(activities || [], wellness || []);



document.getElementById('loading-state').classList.add('hidden');
document.getElementById('dashboard-content').classList.remove('hidden');

}
catch(err)
{

document.getElementById('loading-state').classList.add('hidden');
document.getElementById('error-state').classList.remove('hidden');
document.getElementById('error-msg').textContent = err.message;

console.error(err);

}

});



//
// ===============================
// CALENDAR RENDER
// ===============================
//

function renderCalendar(activities, wellness)
{

const wrap = document.getElementById('calendar-wrap');

if(!wrap) return;


const today = new Date();

const actByDate = {};

activities.forEach(a =>
{
if(!a?.date) return;

if(!actByDate[a.date]) actByDate[a.date] = [];
actByDate[a.date].push(a);
});


const wellnessByDate = {};

wellness.forEach(w =>
{
if(!w?.date) return;
wellnessByDate[w.date] = w;
});


//
// find latest ctl/atl
//

let ctl = null;
let atl = null;

for(let i = wellness.length - 1; i >= 0; i--)
{
if(wellness[i]?.ctl != null && wellness[i]?.atl != null)
{
ctl = wellness[i].ctl;
atl = wellness[i].atl;
break;
}
}



//
// build 5 weeks
//

const start = new Date(today);

const dow = start.getDay();

start.setDate(start.getDate() - (dow === 0 ? 6 : dow - 1));
start.setDate(start.getDate() - 28);


let html = '';

const cursor = new Date(start);


for(let w = 0; w < 5; w++)
{

html += `<div class="calendar-row">`;

const weekNum = getISOWeekNum(cursor);

html += `<div class="cal-week-num">W${weekNum}</div>`;


for(let d = 0; d < 7; d++)
{

const ds = cursor.toISOString().split('T')[0];

const acts = actByDate[ds] || [];
const act = acts.length ? acts[0] : null;


//
// determine tsb
//

let tsb = null;

const wEntry = wellnessByDate[ds];

if(wEntry && wEntry.tsb != null)
{
tsb = wEntry.tsb;
ctl = wEntry.ctl ?? ctl;
atl = wEntry.atl ?? atl;
}
else if(ctl != null && atl != null)
{
tsb = ctl - atl;

const next = predictNextCTLATL(ctl, atl, act?.tss || 0);

ctl = next.ctl;
atl = next.atl;
}


const formClass = getFormClass(tsb);



html += `<div class="cal-day-cell ${formClass} ${act ? 'has-activity' : ''}">

<div class="cal-date-num">${cursor.getDate()}</div>`;


if(act)
{

html += `
<div class="cal-activity-mini">

<div class="cal-mini-name">
${act.name ? act.name.substring(0,16) : ''}
</div>

<div class="cal-mini-stats">
${formatDuration(act.duration)} · ${act.tss || 0}tss
</div>

</div>
`;

}


html += `</div>`;


cursor.setDate(cursor.getDate() + 1);

}


html += `</div>`;

}


wrap.innerHTML = html;

}

</script>   ← ✅ CLOSE the previous script properly


<script>

document.addEventListener("DOMContentLoaded", async function () {

  console.log("Training OS ready");

  try {

    const data = await DATA.loadAll();

    console.log("Dashboard data loaded", data);

    renderCalendar(data.activities, data.wellness);

    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('dashboard-content').classList.remove('hidden');

  } catch (err) {

    console.error("Dashboard failed to load:", err);

    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('error-state').classList.remove('hidden');
    document.getElementById('error-msg').textContent = err.message;

  }

});

</script>



</body>
</html>
