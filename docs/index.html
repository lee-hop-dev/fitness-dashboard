// ===============================
// FORM / TSB HELPERS
// ===============================

function getFormClass(tsb) {
  if (tsb == null) return '';
  return tsb >= 0 ? 'fresh' : 'tired';
}

function predictTSB(lastCTL, lastATL, futureTSS = 0) {
  const ctlTau = 42;
  const atlTau = 7;

  const newCTL = lastCTL + (futureTSS - lastCTL) / ctlTau;
  const newATL = lastATL + (futureTSS - lastATL) / atlTau;

  return newCTL - newATL;
}


// ===============================
// CALENDAR RENDER
// ===============================

function renderCalendar(days, lastKnownCTL = null, lastKnownATL = null) {

  if (!Array.isArray(days)) return;

  let html = '';
  let ctl = lastKnownCTL;
  let atl = lastKnownATL;

  for (let w = 0; w < days.length; w += 7) {

    const week = days.slice(w, w + 7);
    if (!week.length) continue;

    const firstDate = week[0]?.ds;
    const wkNum = firstDate ? getISOWeekNum(new Date(firstDate)) : '';

    html += `<div class="calendar-row">`;
    html += `<div class="cal-week-num">W${wkNum}</div>`;

    week.forEach(day => {

      if (!day) return;

      const act = day.acts && day.acts.length ? day.acts[0] : null;
      const info = act ? getTypeInfo(act.type) : null;

      let tsb = null;

      // Historical form
      if (day.lw && day.lw.tsb != null) {
        tsb = day.lw.tsb;
        ctl = day.lw.ctl ?? ctl;
        atl = day.lw.atl ?? atl;
      }

      // Forward prediction
      else if (ctl != null && atl != null) {
        const tss = act?.tss || 0;
        tsb = predictTSB(ctl, atl, tss);

        ctl = ctl + (tss - ctl) / 42;
        atl = atl + (tss - atl) / 7;
      }

      const formClass = getFormClass(tsb);

      html += `
        <div class="cal-day-cell 
          ${!day.inRange ? 'empty' : ''} 
          ${act ? 'has-activity' : ''} 
          ${day.isToday ? 'today' : ''} 
          ${formClass}
        ">
          <div class="cal-date-num">${day.dayNum || ''}</div>
      `;

      if (act) {
        html += `
          <div class="cal-activity-mini">
            <div class="cal-mini-name ${info?.colorClass || ''}">
              ${act.name ? act.name.substring(0, 16) : ''}
            </div>
            <div class="cal-mini-stats">
              ${formatDuration ? formatDuration(act.duration) : ''} Â· ${act.tss || 0}tss
            </div>
          </div>
        `;
      }

      html += `</div>`; // close day cell
    });

    html += `</div>`; // close week row
  }

  const el = document.getElementById('calendar-body');
  if (el) el.innerHTML = html;
}
