<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lee Hopkins — Training OS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="assets/css/main.css">
</head>

<body>
  <div class="app">

    <nav class="sidebar">
      <div class="sidebar-brand">
        <span class="brand-initials">LH</span>
        <span class="brand-text">Training<br>OS</span>
      </div>
      <ul class="nav-links">
        <li class="nav-item active"><a href="index.html"><span class="nav-icon">◈</span><span>Overview</span></a></li>
        <li class="nav-item"><a href="cycling.html"><span class="nav-icon">⬡</span><span>Cycling</span></a></li>
        <li class="nav-item"><a href="running.html"><span class="nav-icon">▷</span><span>Running</span></a></li>
        <li class="nav-item"><a href="rowing.html"><span class="nav-icon">⊕</span><span>Rowing</span></a></li>
        <li class="nav-item"><a href="cardio.html"><span class="nav-icon">◎</span><span>Cardio</span></a></li>
        <li class="nav-item"><a href="other.html"><span class="nav-icon">○</span><span>Other</span></a></li>
      </ul>
      <div class="sidebar-footer">
        <div class="sync-status">
          <span class="sync-dot"></span>
          <span class="sync-text" id="last-sync">Loading...</span>
        </div>
      </div>
    </nav>

    <main class="main-content">

      <header class="page-header">
        <div class="header-left">
          <h1 class="page-title">Overview</h1>
          <span class="page-subtitle" id="page-subtitle">—</span>
        </div>
        <div class="header-right">
          <div>
            <div class="year-totals">
              <div class="year-stat"><span class="year-stat-value" id="ytd-distance">—</span><span
                  class="year-stat-label">km YTD</span></div>
              <div class="year-stat"><span class="year-stat-value" id="ytd-hours">—</span><span
                  class="year-stat-label">hrs YTD</span></div>
              <div class="year-stat"><span class="year-stat-value" id="ytd-tss">—</span><span
                  class="year-stat-label">TSS YTD</span></div>
            </div>
            <div class="ytd-breakdown">
              <div class="ytd-sport cycling">
                <span class="ytd-sport-label">⬡ Cycling</span>
                <div class="ytd-sport-stats">
                  <div class="ytd-mini"><span class="ytd-mini-val" id="ytd-cy-dist">—</span><span
                      class="ytd-mini-lbl">km</span></div>
                  <div class="ytd-mini"><span class="ytd-mini-val" id="ytd-cy-hrs">—</span><span
                      class="ytd-mini-lbl">hrs</span></div>
                  <div class="ytd-mini"><span class="ytd-mini-val" id="ytd-cy-tss">—</span><span
                      class="ytd-mini-lbl">TSS</span></div>
                </div>
              </div>
              <div class="ytd-sport running">
                <span class="ytd-sport-label">▷ Running</span>
                <div class="ytd-sport-stats">
                  <div class="ytd-mini"><span class="ytd-mini-val" id="ytd-ru-dist">—</span><span
                      class="ytd-mini-lbl">km</span></div>
                  <div class="ytd-mini"><span class="ytd-mini-val" id="ytd-ru-hrs">—</span><span
                      class="ytd-mini-lbl">hrs</span></div>
                  <div class="ytd-mini"><span class="ytd-mini-val" id="ytd-ru-tss">—</span><span
                      class="ytd-mini-lbl">TSS</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div id="loading-state" class="loading-overlay">
        <div class="loading-spinner"></div>
        <span id="loading-msg">Loading dashboard data...</span>
      </div>

      <div id="error-state" class="error-state hidden">
        <strong>No data found.</strong> <span id="error-msg"></span>
      </div>

      <div id="dashboard-content" class="hidden">
        <!-- Metrics Row -->
        <!-- ... all your metric cards, charts, sections ... -->
        <!-- Keep your content exactly as before, no changes needed in HTML structure -->
      </div>
    </main>
  </div>

  <!-- Load scripts in order with defer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" defer></script>
  <script src="assets/js/charts.js" defer></script>
  <script src="assets/js/data-loader.js" defer></script>

  <!-- Dashboard initialization -->
  <script defer>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const { activities, wellness, weeklyTSS, ytd, heatmap1y, athlete, meta } = await DATA.loadAll();

        const updated = new Date(meta.last_updated);
        document.getElementById('last-sync').textContent = 'Updated ' + updated.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        document.getElementById('page-subtitle').textContent = new Date().getFullYear() + ' · Week ' + getISOWeekNum(new Date());

        const lw = DATA.latestWellness(wellness);
        const tsb = lw.tsb != null ? lw.tsb : (lw.ctl != null && lw.atl != null ? lw.ctl - lw.atl : null);

        const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };
        setText('ctl-value', lw.ctl?.toFixed(1) ?? '—');
        setText('atl-value', lw.atl?.toFixed(1) ?? '—');
        setText('tsb-value', tsb != null ? (tsb >= 0 ? '+' : '') + tsb.toFixed(1) : '—');
        setText('hrv-value', lw.hrv ?? '—');
        setText('rhr-value', lw.resting_hr ?? '—');
        setText('sleep-value', lw.sleep ?? '—');
        const weight = athlete?.weight ?? lw.weight;
        setText('weight-value', weight ? weight.toFixed(1) : '—');

        const setBar = (id, val, max) => { const el = document.getElementById(id); if (el && val != null) el.style.width = Math.min(100, (val / max) * 100) + '%'; };
        setBar('ctl-bar', lw.ctl, 120);
        setBar('atl-bar', lw.atl, 120);
        setBar('hrv-bar', lw.hrv, 100);
        setBar('sleep-bar', lw.sleep, 10);

        const tsbBar = document.getElementById('tsb-bar');
        if (tsbBar && tsb != null) tsbBar.style.width = Math.min(100, Math.max(0, 50 + tsb * 2)) + '%';

        // Charts
        const fitnessTrend = wellness.filter(w => w.ctl != null).map(w => ({ ...w, tsb: w.tsb != null ? w.tsb : (w.ctl - w.atl) }));
        if (fitnessTrend.length) {
          const pbs = DATA.pbMarkers ? DATA.pbMarkers(activities, wellness) : [];
          setupFitnessToggle('fitnessChart', fitnessTrend, pbs);
        }

        if (weeklyTSS?.length) buildTSSChart('tssChart', weeklyTSS);

        const wellnessWithData = wellness.filter(w => w.hrv != null || w.sleep != null);
        if (wellnessWithData.length) {
          setupHRVSleepToggle('hrvSleepChart', {
            dates: wellnessWithData.map(w => w.date),
            hrv: wellnessWithData.map(w => w.hrv),
            sleep: wellnessWithData.map(w => w.sleep)
          });
        }

        renderActivityCards(DATA.recentActivities(activities, 7));
        renderCalendar(activities);
        renderHeatmap(heatmap1y);

        const powerBests = DATA.powerBests(activities);
        const paceBests = DATA.paceBests(activities);
        if (powerBests.length) buildPowerBestsChart('powerBestsChart', powerBests);
        if (paceBests.length) buildPaceBestsChart('paceBestsChart', paceBests);
        renderBestsTables(powerBests, paceBests);

        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.bests-container').forEach(c => c.classList.add('hidden'));
            document.getElementById(tab.dataset.tab).classList.remove('hidden');
          });
        });

        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('dashboard-content').classList.remove('hidden');

      } catch (err) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
        document.getElementById('error-msg').textContent = err.message;
        console.error('Dashboard error:', err);
      }
    });
  </script>
</body>

</html>
