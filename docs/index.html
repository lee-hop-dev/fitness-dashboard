<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Dashboard - Overview</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>Fitness Dashboard</h1>
            <nav class="dashboard-nav">
                <a href="index.html" class="nav-link active">Overview</a>
                <a href="cycling.html" class="nav-link">Cycling</a>
                <a href="running.html" class="nav-link">Running</a>
                <a href="rowing.html" class="nav-link">Rowing</a>
                <a href="cardio.html" class="nav-link">Cardio</a>
                <a href="other.html" class="nav-link">Other</a>
            </nav>
        </header>

        <main class="dashboard-main">
            <!-- Athlete Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <h3>Weight</h3>
                    <div class="stat-value" id="weight-value">--</div>
                    <div class="stat-unit">kg</div>
                </div>
                <div class="stat-card">
                    <h3>FTP</h3>
                    <div class="stat-value" id="ftp-value">--</div>
                    <div class="stat-unit">W</div>
                </div>
                <div class="stat-card">
                    <h3>W'bal</h3>
                    <div class="stat-value" id="wbal-value">--</div>
                    <div class="stat-unit">J</div>
                </div>
            </section>

            <!-- Fitness Trend -->
            <section class="card">
                <h2>Fitness Trend (30 days)</h2>
                <div class="fitness-trend-table">
                    <table id="fitness-trend-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Current</th>
                                <th>Unit</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>CTL (Fitness)</td>
                                <td id="ctl-value">--</td>
                                <td>TSS/day</td>
                                <td id="ctl-status">--</td>
                            </tr>
                            <tr>
                                <td>ATL (Fatigue)</td>
                                <td id="atl-value">--</td>
                                <td>TSS/day</td>
                                <td id="atl-status">--</td>
                            </tr>
                            <tr>
                                <td>TSB (Form)</td>
                                <td id="tsb-value">--</td>
                                <td>TSS</td>
                                <td id="tsb-status">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Weekly TSS Chart -->
            <section class="card">
                <h2>Weekly Training Stress Score</h2>
                <div class="chart-container">
                    <canvas id="weekly-tss-chart"></canvas>
                </div>
            </section>

            <!-- HRV & Sleep -->
            <section class="card">
                <h2>Recovery Metrics</h2>
                <div class="recovery-table">
                    <table id="recovery-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Latest</th>
                                <th>Unit</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>HRV</td>
                                <td id="hrv-value">--</td>
                                <td>ms</td>
                                <td id="hrv-trend">--</td>
                            </tr>
                            <tr>
                                <td>Resting HR</td>
                                <td id="rhr-value">--</td>
                                <td>bpm</td>
                                <td id="rhr-trend">--</td>
                            </tr>
                            <tr>
                                <td>Sleep</td>
                                <td id="sleep-value">--</td>
                                <td>hours</td>
                                <td id="sleep-trend">--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Training Summary -->
            <section class="training-summary">
                <div class="summary-card">
                    <h3>90-Day Cycling</h3>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <span class="stat-label">Rides</span>
                            <span class="stat-value" id="cycling-count">--</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Distance</span>
                            <span class="stat-value" id="cycling-distance">--</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Time</span>
                            <span class="stat-value" id="cycling-time">--</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Elevation</span>
                            <span class="stat-value" id="cycling-elevation">--</span>
                        </div>
                    </div>
                    <div class="activity-chart-container">
                        <canvas id="cycling-trend-chart" width="300" height="100"></canvas>
                    </div>
                </div>

                <div class="summary-card">
                    <h3>90-Day Running</h3>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <span class="stat-label">Runs</span>
                            <span class="stat-value" id="running-count">--</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Distance</span>
                            <span class="stat-value" id="running-distance">--</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Time</span>
                            <span class="stat-value" id="running-time">--</span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Elevation</span>
                            <span class="stat-value" id="running-elevation">--</span>
                        </div>
                    </div>
                    <div class="activity-chart-container">
                        <canvas id="running-trend-chart" width="300" height="100"></canvas>
                    </div>
                </div>
            </section>

            <!-- Activity Calendar Heatmap -->
            <section class="card">
                <h2>Activity Calendar (1 Year)</h2>
                <div class="calendar-controls">
                    <button id="calendar-prev">‹ Previous</button>
                    <span id="calendar-title">2025</span>
                    <button id="calendar-next">Next ›</button>
                </div>
                <div id="activity-calendar" class="activity-calendar"></div>
                <div class="calendar-legend">
                    <span class="legend-item">
                        <span class="legend-color cycling"></span>
                        Cycling
                    </span>
                    <span class="legend-item">
                        <span class="legend-color running"></span>
                        Running
                    </span>
                    <span class="legend-item">
                        <span class="legend-color rowing"></span>
                        Rowing
                    </span>
                    <span class="legend-item">
                        <span class="legend-color cardio"></span>
                        Cardio
                    </span>
                    <span class="legend-item">
                        <span class="legend-color other"></span>
                        Other
                    </span>
                </div>
            </section>
        </main>
    </div>

    <script src="assets/js/data-loader.js"></script>
    <script src="assets/js/charts.js"></script>
    <script>
        async function initOverviewPage() {
            try {
                // Load all data
                const { activities, wellness, athlete, weeklyTSS, ytd, heatmap1y, heatmap3y, meta } = await DATA.loadAll();
                
                console.log('Loaded data:', { activities: activities?.length, wellness: wellness?.length, athlete, weeklyTSS: weeklyTSS?.length });

                // Update athlete stats
                updateAthleteStats(athlete, activities, wellness);
                
                // Update fitness trend
                updateFitnessTrend(wellness);
                
                // Update weekly TSS chart
                updateWeeklyTSSChart(weeklyTSS);
                
                // Update recovery metrics
                updateRecoveryMetrics(wellness);
                
                // Update training summaries
                updateTrainingSummaries(activities);
                
                // Update activity calendar
                updateActivityCalendar(heatmap1y);
                
            } catch (error) {
                console.error('Error initializing overview page:', error);
            }
        }

        function updateAthleteStats(athlete, activities, wellness) {
            // Get latest wellness data
            const lw = DATA.latestWellness(wellness);
            
            // Weight from athlete or latest wellness
            const weight = athlete?.weight || lw?.weight;
            document.getElementById('weight-value').textContent = weight ? weight.toFixed(1) : '--';
            
            // FTP from athlete or latest activity
            const ftp = athlete?.ftp || getLatestFTP(activities);
            document.getElementById('ftp-value').textContent = ftp || '--';
            
            // W'bal from athlete or latest activity
            const wbal = athlete?.w_prime || getLatestWBal(activities);
            document.getElementById('wbal-value').textContent = wbal ? Math.round(wbal).toLocaleString() : '--';
        }

        function getLatestFTP(activities) {
            if (!activities || activities.length === 0) return null;
            
            // Find most recent activity with FTP
            for (let i = activities.length - 1; i >= 0; i--) {
                if (activities[i]?.icu_ftp) {
                    return activities[i].icu_ftp;
                }
            }
            return null;
        }

        function getLatestWBal(activities) {
            if (!activities || activities.length === 0) return null;
            
            // Find most recent activity with W'bal
            for (let i = activities.length - 1; i >= 0; i--) {
                if (activities[i]?.icu_w_prime) {
                    return activities[i].icu_w_prime;
                }
            }
            return null;
        }

        function updateFitnessTrend(wellness) {
            const lw = DATA.latestWellness(wellness);
            
            // Update CTL
            const ctl = lw?.ctl;
            document.getElementById('ctl-value').textContent = ctl ? Math.round(ctl) : '--';
            document.getElementById('ctl-status').textContent = getFormStatus(ctl, 'ctl');
            
            // Update ATL
            const atl = lw?.atl;
            document.getElementById('atl-value').textContent = atl ? Math.round(atl) : '--';
            document.getElementById('atl-status').textContent = getFormStatus(atl, 'atl');
            
            // Update TSB
            const tsb = lw?.tsb;
            document.getElementById('tsb-value').textContent = tsb ? Math.round(tsb) : '--';
            document.getElementById('tsb-status').textContent = getTSBStatus(tsb);
        }

        function getFormStatus(value, type) {
            if (!value) return '--';
            
            if (type === 'ctl') {
                if (value > 80) return 'High';
                if (value > 40) return 'Good';
                return 'Low';
            }
            
            if (type === 'atl') {
                if (value > 60) return 'High';
                if (value > 30) return 'Moderate';
                return 'Low';
            }
            
            return '--';
        }

        function getTSBStatus(tsb) {
            if (!tsb) return '--';
            
            if (tsb > 10) return 'Fresh';
            if (tsb > -10) return 'Neutral';
            if (tsb > -30) return 'Tired';
            return 'Very Tired';
        }

        function updateWeeklyTSSChart(weeklyTSS) {
            if (!weeklyTSS || weeklyTSS.length === 0) {
                console.warn('No weekly TSS data available');
                return;
            }

            const ctx = document.getElementById('weekly-tss-chart');
            if (!ctx) return;

            const chartData = DATA.getWeeklyTSSChart(weeklyTSS);
            const last12Weeks = chartData.slice(-12);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: last12Weeks.map(week => {
                        const date = new Date(week.date);
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    }),
                    datasets: [{
                        label: 'Total TSS',
                        data: last12Weeks.map(week => week.tss),
                        backgroundColor: 'var(--accent)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'var(--border-color)' },
                            ticks: { color: 'var(--text-muted)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--text-muted)' }
                        }
                    }
                }
            });
        }

        function updateRecoveryMetrics(wellness) {
            const lw = DATA.latestWellness(wellness);
            
            // Update HRV
            const hrv = lw?.hrv;
            document.getElementById('hrv-value').textContent = hrv ? Math.round(hrv) : '--';
            document.getElementById('hrv-trend').textContent = getRecoveryTrend(wellness, 'hrv');
            
            // Update Resting HR
            const rhr = lw?.resting_hr;
            document.getElementById('rhr-value').textContent = rhr ? Math.round(rhr) : '--';
            document.getElementById('rhr-trend').textContent = getRecoveryTrend(wellness, 'resting_hr');
            
            // Update Sleep
            const sleep = lw?.sleep;
            document.getElementById('sleep-value').textContent = sleep ? (sleep / 3600).toFixed(1) : '--';
            document.getElementById('sleep-trend').textContent = getRecoveryTrend(wellness, 'sleep');
        }

        function getRecoveryTrend(wellness, metric) {
            if (!wellness || wellness.length < 7) return '--';
            
            const recent = wellness.slice(-7).filter(w => w && w[metric] !== null);
            if (recent.length < 3) return '--';
            
            const latest = recent[recent.length - 1][metric];
            const previous = recent[0][metric];
            
            if (latest > previous * 1.05) return '↗';
            if (latest < previous * 0.95) return '↘';
            return '→';
        }

        function updateTrainingSummaries(activities) {
            if (!activities || activities.length === 0) {
                console.warn('No activities data available');
                return;
            }

            // Update cycling summary
            const cycling = DATA.getCyclingActivities(activities);
            const cyclingTotals = DATA.getActivityTotals(cycling, 90);
            
            document.getElementById('cycling-count').textContent = cyclingTotals.count;
            document.getElementById('cycling-distance').textContent = DATA.formatDistance(cyclingTotals.distance);
            document.getElementById('cycling-time').textContent = DATA.formatTime(cyclingTotals.time);
            document.getElementById('cycling-elevation').textContent = `${Math.round(cyclingTotals.elevation)}m`;
            
            // Update running summary
            const running = DATA.getRunningActivities(activities);
            const runningTotals = DATA.getActivityTotals(running, 90);
            
            document.getElementById('running-count').textContent = runningTotals.count;
            document.getElementById('running-distance').textContent = DATA.formatDistance(runningTotals.distance);
            document.getElementById('running-time').textContent = DATA.formatTime(runningTotals.time);
            document.getElementById('running-elevation').textContent = `${Math.round(runningTotals.elevation)}m`;
            
            // Create mini trend charts
            createTrendChart('cycling-trend-chart', cycling);
            createTrendChart('running-trend-chart', running);
        }

        function createTrendChart(canvasId, activities) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !activities.length) return;

            const ctx = canvas.getContext('2d');
            const last30Days = getLast30DaysData(activities);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30Days.map(d => d.date),
                    datasets: [{
                        data: last30Days.map(d => d.tss),
                        borderColor: 'var(--accent)',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    elements: {
                        point: { radius: 0 }
                    }
                }
            });
        }

        function getLast30DaysData(activities) {
            const last30Days = [];
            const now = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const dayActivities = activities.filter(a => 
                    a.start_date_local && 
                    a.start_date_local.startsWith(dateStr)
                );
                
                const tss = dayActivities.reduce((sum, a) => sum + (a.tss || 0), 0);
                
                last30Days.push({ date: dateStr, tss });
            }
            
            return last30Days;
        }

        function updateActivityCalendar(heatmap) {
            if (!heatmap) {
                console.warn('No heatmap data available');
                return;
            }

            const calendarContainer = document.getElementById('activity-calendar');
            if (!calendarContainer) return;

            const processedData = DATA.processHeatmapData(heatmap);
            
            // Create calendar grid for 2025
            createCalendarGrid(calendarContainer, processedData, 2025);
        }

        function createCalendarGrid(container, data, year) {
            container.innerHTML = '';
            
            const months = [
                'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
            ];
            
            // Create month headers
            const headerRow = document.createElement('div');
            headerRow.className = 'calendar-header';
            
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-cell header';
            headerRow.appendChild(emptyCell);
            
            months.forEach(month => {
                const monthCell = document.createElement('div');
                monthCell.className = 'calendar-cell header';
                monthCell.textContent = month;
                headerRow.appendChild(monthCell);
            });
            
            container.appendChild(headerRow);
            
            // Create day grid (aligned properly)
            for (let week = 0; week < 53; week++) {
                const weekRow = document.createElement('div');
                weekRow.className = 'calendar-week';
                
                // Week number or day label
                const weekLabel = document.createElement('div');
                weekLabel.className = 'calendar-cell week-label';
                if (week === 0) weekLabel.textContent = '';
                weekRow.appendChild(weekLabel);
                
                for (let month = 0; month < 12; month++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-cell day';
                    
                    // Calculate actual date
                    const date = new Date(year, month, 1);
                    date.setDate(date.getDate() + (week * 7));
                    
                    if (date.getMonth() === month) {
                        const dateStr = date.toISOString().split('T')[0];
                        const dayData = data[dateStr];
                        
                        if (dayData) {
                            dayCell.classList.add('has-activity');
                            dayCell.classList.add(getActivityTypeClass(dayData.primaryType));
                            dayCell.title = `${dateStr}: ${dayData.count} activities, ${Math.round(dayData.tss)} TSS`;
                            
                            // Intensity based on TSS
                            const intensity = Math.min(4, Math.floor(dayData.tss / 50));
                            dayCell.classList.add(`intensity-${intensity}`);
                        }
                    }
                    
                    weekRow.appendChild(dayCell);
                }
                
                container.appendChild(weekRow);
            }
        }

        function getActivityTypeClass(activityType) {
            const typeMap = {
                'Ride': 'cycling',
                'VirtualRide': 'cycling',
                'Run': 'running',
                'VirtualRun': 'running',
                'Rowing': 'rowing',
                'Row': 'rowing'
            };
            
            return typeMap[activityType] || 'other';
        }

        // Initialize page when DOM is ready
        document.addEventListener('DOMContentLoaded', initOverviewPage);
    </script>
</body>
</html>
