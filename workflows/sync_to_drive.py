"""
Google Drive Sync Script
Uploads collected data to Google Drive for storage and GitHub Actions access
"""

import os
import sys
import json
import logging
from pathlib import Path
from datetime import datetime
from typing import Optional

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from google.oauth2 import service_account
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload
from googleapiclient.errors import HttpError
from dotenv import load_dotenv

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Scopes required for Google Drive access
SCOPES = ['https://www.googleapis.com/auth/drive.file']


class GoogleDriveSync:
    """Sync local data to Google Drive"""
    
    def __init__(self):
        """Initialize Google Drive sync"""
        load_dotenv()
        
        self.folder_id = os.getenv("GOOGLE_DRIVE_FOLDER_ID")
        if not self.folder_id:
            raise ValueError("GOOGLE_DRIVE_FOLDER_ID not found in environment")
        
        
        self.service = self._authenticate()
        self.subfolder_ids = self._get_or_create_subfolders()
    
    def _authenticate(self):
        """Authenticate using Service Account (CI-safe)"""
        logger.info("Authenticating with Google Drive (Service Account)...")

        service_account_info = os.getenv("GOOGLE_SERVICE_ACCOUNT_JSON")

        if not service_account_info:
            raise ValueError("GOOGLE_SERVICE_ACCOUNT_JSON not found in environment")

        credentials = service_account.Credentials.from_service_account_info(
            json.loads(service_account_info),
            scopes=SCOPES,
        )

        logger.info("Successfully authenticated with Google Drive")
        return build('drive', 'v3', credentials=credentials)


    
    def _get_or_create_subfolders(self) -> dict:
        """Get or create raw/processed/cache subfolders"""
        logger.info("Setting up folder structure...")
        
        subfolder_names = ["raw", "processed", "cache"]
        subfolder_ids = {}
        
        for name in subfolder_names:
            folder_id = self._find_or_create_folder(name, self.folder_id)
            subfolder_ids[name] = folder_id
            logger.info(f"  {name}: {folder_id}")
        
        return subfolder_ids
    
    def _find_or_create_folder(self, name: str, parent_id: str) -> str:
        """Find existing folder or create new one"""
        try:
            # Search for existing folder
            query = f"name='{name}' and '{parent_id}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false"
            results = self.service.files().list(
                q=query,
                spaces='drive',
                fields='files(id, name)'
            ).execute()
            
            files = results.get('files', [])
            
            if files:
                return files[0]['id']
            
            # Create new folder
            file_metadata = {
                'name': name,
                'mimeType': 'application/vnd.google-apps.folder',
                'parents': [parent_id]
            }
            
            folder = self.service.files().create(
                body=file_metadata,
                fields='id'
            ).execute()
            
            return folder['id']
            
        except HttpError as error:
            logger.error(f"Error with folder {name}: {error}")
            raise
    
    def upload_file(self, filepath: Path, subfolder: str = "processed") -> Optional[str]:
        """
        Upload file to Google Drive
        
        Args:
            filepath: Local file path
            subfolder: Destination subfolder (raw/processed/cache)
            
        Returns:
            File ID if successful, None otherwise
        """
        if not filepath.exists():
            logger.error(f"File not found: {filepath}")
            return None
        
        try:
            parent_id = self.subfolder_ids.get(subfolder, self.folder_id)
            
            # Check if file already exists
            existing_id = self._find_file(filepath.name, parent_id)
            
            file_metadata = {
                'name': filepath.name,
                'parents': [parent_id]
            }
            
            media = MediaFileUpload(
                str(filepath),
                mimetype='application/json',
                resumable=True
            )
            
            if existing_id:
                # Update existing file
                logger.info(f"Updating existing file: {filepath.name}")
                file = self.service.files().update(
                    fileId=existing_id,
                    media_body=media,
                    fields='id'
                ).execute()
            else:
                # Create new file
                logger.info(f"Uploading new file: {filepath.name}")
                file = self.service.files().create(
                    body=file_metadata,
                    media_body=media,
                    fields='id'
                ).execute()
            
            logger.info(f"  File ID: {file['id']}")
            return file['id']
            
        except HttpError as error:
            logger.error(f"Upload failed for {filepath.name}: {error}")
            return None
    
    def _find_file(self, filename: str, parent_id: str) -> Optional[str]:
        """Find file in Google Drive folder"""
        try:
            query = f"name='{filename}' and '{parent_id}' in parents and trashed=false"
            results = self.service.files().list(
                q=query,
                spaces='drive',
                fields='files(id, name)'
            ).execute()
            
            files = results.get('files', [])
            return files[0]['id'] if files else None
            
        except HttpError:
            return None
    
    def sync_directory(self, local_dir: Path, subfolder: str = "processed") -> int:
        """
        Sync entire directory to Google Drive
        
        Args:
            local_dir: Local directory path
            subfolder: Destination subfolder
            
        Returns:
            Number of files uploaded
        """
        logger.info(f"Syncing directory: {local_dir} â†’ {subfolder}")
        
        if not local_dir.exists():
            logger.warning(f"Directory not found: {local_dir}")
            return 0
        
        uploaded = 0
        
        for filepath in local_dir.glob("*.json"):
            if self.upload_file(filepath, subfolder):
                uploaded += 1
        
        logger.info(f"Uploaded {uploaded} files from {local_dir}")
        return uploaded
    
    def download_file(self, file_id: str, destination: Path):
        """
        Download file from Google Drive
        
        Args:
            file_id: Google Drive file ID
            destination: Local destination path
        """
        try:
            request = self.service.files().get_media(fileId=file_id)
            
            with open(destination, 'wb') as f:
                from googleapiclient.http import MediaIoBaseDownload
                import io
                
                fh = io.BytesIO()
                downloader = MediaIoBaseDownload(fh, request)
                
                done = False
                while not done:
                    status, done = downloader.next_chunk()
                    logger.info(f"Download progress: {int(status.progress() * 100)}%")
                
                fh.seek(0)
                f.write(fh.read())
            
            logger.info(f"Downloaded to: {destination}")
            
        except HttpError as error:
            logger.error(f"Download failed: {error}")
            raise


def main():
    """Main entry point"""
    import argparse
    
    parser = argparse.ArgumentParser(description="Sync data to Google Drive")
    parser.add_argument(
        "--upload-raw",
        action="store_true",
        help="Upload raw data files"
    )
    parser.add_argument(
        "--upload-processed",
        action="store_true",
        help="Upload processed data files"
    )
    parser.add_argument(
        "--all",
        action="store_true",
        help="Upload all data files"
    )
    
    args = parser.parse_args()
    
    try:
        sync = GoogleDriveSync()
        
        total_uploaded = 0
        
        if args.upload_raw or args.all:
            total_uploaded += sync.sync_directory(Path("data/raw"), "raw")
        
        if args.upload_processed or args.all:
            total_uploaded += sync.sync_directory(Path("data/processed"), "processed")
        
        if not (args.upload_raw or args.upload_processed or args.all):
            # Default: upload processed only
            total_uploaded += sync.sync_directory(Path("data/processed"), "processed")
        
        logger.info("=" * 60)
        logger.info(f"Sync complete! Total files uploaded: {total_uploaded}")
        logger.info("=" * 60)
        
    except Exception as e:
        logger.error(f"Sync failed: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
